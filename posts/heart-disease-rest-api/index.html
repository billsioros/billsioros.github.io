<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta http-equiv=accept-ch content="DPR, Viewport-Width, Width"><link rel=icon href=/fav.png type=image/gif><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload="this.media='all'"><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','G-7GQWQMNEX0','auto');ga('send','pageview');}</script><meta property="og:title" content="Building a REST API"><meta property="og:description" content="FastAPI to the Rescue!"><meta property="og:type" content="article"><meta property="og:url" content="https://billsioros.github.io/posts/heart-disease-rest-api/"><meta property="article:published_time" content="2024-09-05T00:00:00+00:00"><meta property="article:modified_time" content="2024-09-05T00:00:00+00:00"><meta property="og:site_name" content="Vassilis Sioros"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building a REST API"><meta name=twitter:description content="FastAPI to the Rescue!"><link rel=stylesheet href=/bootstrap-5/css/bootstrap.min.css media=all><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><style>:root{--text-color: #343a40;--text-secondary-color: #6c757d;--background-color: #eaedf0;--secondary-background-color: #64ffda1a;--primary-color: #007bff;--brand-color: #007bff;--secondary-color: #f8f9fa;--text-color-dark: #e4e6eb;--text-secondary-color-dark: #b0b3b8;--background-color-dark: #18191a;--secondary-background-color-dark: #212529;--primary-color-dark: #007bff;--brand-color-dark: #ffffff;--secondary-color-dark: #212529}body{min-height:100%;display:flex;flex-direction:column;font-size:1rem;font-weight:400;line-height:1.5;text-align:left}html{height:100%;background-color:var(--background-color)!important}body::-webkit-scrollbar{height:0;width:8px;background-color:var(--background-color)}::-webkit-scrollbar-track{border-radius:1rem}::-webkit-scrollbar-thumb{border-radius:1rem;background:#b0b0b0;outline:1px solid var(--background-color)}#search-content::-webkit-scrollbar{width:.5em;height:.1em;background-color:var(--background-color)}</style><meta name=description content="FastAPI to the Rescue!"><meta name=author content="Vassilis Sioros"><meta property="og:image" content="https://billsioros.github.io/images/posts/heart-disease-rest-api/index.png"><link rel=stylesheet href=/css/single.css><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[['\\[','\\]'],['$$','$$']],inlineMath:[['\\(','\\)']]}};</script><script defer src=/fontawesome-6/all-6.4.2.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.25.0/tocbot.css><script src=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.25.0/tocbot.min.js></script><title>Building a REST API | Vassilis Sioros | Software / Machine Learning Engineer</title></head><body class=light><script>let localStorageValue=localStorage.getItem("pref-theme");let mediaQuery=window.matchMedia('(prefers-color-scheme: dark)').matches;switch(localStorageValue){case "dark":document.body.classList.add('dark');break;case "light":document.body.classList.remove('dark');break;default:if(mediaQuery){document.body.classList.add('dark');}
break;}</script><script>var prevScrollPos=window.pageYOffset;window.addEventListener("scroll",function showHeaderOnScroll(){let profileHeaderElem=document.getElementById("profileHeader");let currentScrollPos=window.pageYOffset;let resetHeaderStyle=false;let showNavBarOnScrollUp=false;let showNavBar=showNavBarOnScrollUp?prevScrollPos>currentScrollPos:currentScrollPos>0;if(showNavBar){profileHeaderElem.classList.add("showHeaderOnTop");}else{resetHeaderStyle=true;}
if(currentScrollPos===0){resetHeaderStyle=true;}
if(resetHeaderStyle){profileHeaderElem.classList.remove("showHeaderOnTop");}
prevScrollPos=currentScrollPos;});</script><header id=profileHeader><nav class="pb-2 navbar navbar-expand-lg animate"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/><img src=/fav.png width=30 height=30 class="d-inline-block align-top">
Vassilis Sioros</a><div class="d-flex justify-content-end" style=flex-grow:1><button id=theme-toggle type=checkbox></button></div><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation"><svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" style=flex-grow:0!important id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text"><a class=nav-link href=/#experience aria-label=experience>Experience</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#education aria-label=education>Education</a></li><li class="nav-item navbar-text"><a class=nav-link href=/#projects aria-label=projects>Projects</a></li><li class="nav-item navbar-text"><a class=nav-link href=/posts title="Blog posts">Blog</a></li></ul></div></div></nav></header><div id=content><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><div class="title mb-5"><h1 class="text-center mb-4">Building a REST API</h1><h6 class="text-center mb-4">FastAPI to the Rescue!</h6><div class=text-center>Sep 5, 2024
<span id=readingTime>min read</span>
<small>|</small>
<a target=_blank href=https://colab.research.google.com/github/billsioros/billsioros.github.io/blob/master/static/code/heart-disease-rest-api.ipynb><img src=https://colab.research.google.com/assets/colab-badge.svg alt="Open In Colab"></a></div></div><div class=featured-image><img class="img-fluid mx-auto d-block" src=/images/posts/heart-disease-rest-api/index.png alt="Building a REST API"></div><article class="page-content toc-content p-2"><p>Heart disease is like the uninvited guest that crashes the party, causing 17.9 million deaths every year—about 31% of all deaths worldwide, with many victims under 70. But what if we could predict when this party crasher is coming? That’s where machine learning steps in, superhero-style! These models act like crystal balls for your health, scanning data for warning signs like high blood pressure or cholesterol to predict who’s at risk of heart disease.</p><p>In a <a href=https://billsioros.github.io/posts/heart-disease-prediction/>previous post</a>, we trained one of these models using the <a href=https://www.kaggle.com/datasets/fedesoriano/heart-failure-prediction>Heart Disease Prediction Dataset</a>. Now, we’re going to kick things up a notch and build a REST API to make this model accessible to the world! And our tool of choice? <a href=https://fastapi.tiangolo.com/><code>FastAPI</code></a>, <em>a lightning-fast, easy-to-use framework that makes building APIs with Python a breeze.</em></p><p>So, what’s a <a href=https://en.wikipedia.org/wiki/REST><code>REST</code></a> API, you ask? It’s how apps talk to each other over the internet. REST APIs handle requests like <code>GET</code> (grab info), <code>POST</code> (send info), <code>PUT</code> (update info), and <code>DELETE</code> (bye-bye info). FastAPI makes setting this up simple, fast, and fun. Ready to dive in? Let’s get started!</p><h2 id=crafting-a-data-blueprint>Crafting a Data Blueprint</h2><p>First, we need a blueprint for the data that users will send us, kind of like a form where they fill in their details. For this, we use <a href=https://docs.pydantic.dev/latest/><code>Pydantic</code></a>. So, what’s Pydantic? Think of it as the bouncer for your API—it checks that all incoming data is valid and properly structured before letting it through.</p><p>Here’s a quick rundown of what’s happening:</p><ul><li>This is our blueprint for incoming data. It’s like a form where users fill in their details. Each field comes with rules (e.g., age must be between 0 and 130) so we’re working with data that makes sense and fits what our machine learning model needs.</li><li>We use <code>IntEnum</code> from Python’s <code>enum</code> module to handle categories like <code>Sex</code>, <code>ChestPain</code>, and <code>StSlope</code>. These ensure only valid options are passed.</li><li>The <code>Field</code> function lets us set validation rules (e.g., minimum and maximum values) and add descriptions. This way, anyone using the API knows exactly what each field is for—no guesswork required!</li><li>The <code>HeartBeatSchema</code> is an extension of <code>HeartBeatCreateSchema</code>. It adds extra fields like <code>id</code>, which acts as a unique identifier for each record, and <code>heart_disease</code>, which holds the prediction from our model. Think of <code>HeartBeatSchema</code> as mimicking a database record creation operation—it&rsquo;s what you&rsquo;ll get back once the data is processed and stored.</li></ul><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>Sex</span><span class=p>(</span><span class=n>IntEnum</span><span class=p>):</span>
    <span class=n>MALE</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>
    <span class=n>FEMALE</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>


<span class=k>class</span> <span class=nc>ChestPain</span><span class=p>(</span><span class=n>IntEnum</span><span class=p>):</span>
    <span class=n>TYPICAL_ANGINA</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>
    <span class=n>ATYPICAL_ANGINA</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>
    <span class=n>NON_ANGINAL_PAIN</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>
    <span class=n>ASYMPTOMATIC</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>


<span class=k>class</span> <span class=nc>StSlope</span><span class=p>(</span><span class=n>IntEnum</span><span class=p>):</span>
    <span class=n>UP</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>
    <span class=n>FLAT</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>
    <span class=n>DOWN</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>
</code></pre></div><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>HeartBeatCreateSchema</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
    <span class=k>class</span> <span class=nc>Config</span><span class=p>:</span>
        <span class=n>from_attributes</span> <span class=o>=</span> <span class=bp>True</span>

    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>130</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;Age of the patient [years]&#34;</span><span class=p>)</span>
    <span class=n>sex</span><span class=p>:</span> <span class=n>Sex</span>
    <span class=n>chest_pain_type</span><span class=p>:</span> <span class=n>ChestPain</span>
    <span class=n>fasting_blood_sugar</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
        <span class=o>...</span><span class=p>,</span>
        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;Fasting blood sugar [1: if FastingBS &gt; 120 mg/dl, 0: otherwise]&#34;</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=n>max_heart_rate</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
        <span class=o>...</span><span class=p>,</span>
        <span class=n>ge</span><span class=o>=</span><span class=mi>60</span><span class=p>,</span>
        <span class=n>le</span><span class=o>=</span><span class=mi>300</span><span class=p>,</span>
        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;Maximum heart rate achieved [Numeric value between 60 and 202]&#34;</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=n>exercise_angina</span><span class=p>:</span> <span class=nb>bool</span>
    <span class=n>old_peak</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
        <span class=o>...</span><span class=p>,</span>
        <span class=n>ge</span><span class=o>=-</span><span class=mi>10</span><span class=p>,</span>
        <span class=n>le</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;Oldpeak = ST [Numeric value measured in depression]&#34;</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=n>st_slope</span><span class=p>:</span> <span class=n>StSlope</span>
</code></pre></div><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>HeartBeatSchema</span><span class=p>(</span><span class=n>HeartBeatCreateSchema</span><span class=p>):</span>
    <span class=nb>id</span><span class=p>:</span> <span class=nb>str</span>
    <span class=n>heart_disease</span><span class=p>:</span> <span class=nb>bool</span>
</code></pre></div><h2 id=building-the-bot>Building the Bot</h2><p>We’ll now define a bot that predicts whether someone has heart disease based on their health data. Here’s how it functions:</p><ol><li><strong>Initialization</strong>: When we create our <code>Bot</code>, we supply it with the pretrained model we’ve previously developed.</li><li><strong>Data Processing</strong>: When the bot receives a new health report in the form of a <code>HeartBeatCreateSchem</code> payload, it first converts this data into a format compatible with the model—using a pandas DataFrame, which was the format used during training.</li><li><strong>Prediction</strong>: The bot then feeds the processed data into the model. The model evaluates the input and provides a prediction, indicating whether heart disease is likely with a <code>True</code> or <code>False</code>.</li></ol><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>Bot</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model</span><span class=p>:</span> <span class=n>Pipeline</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=bp>None</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_model</span> <span class=o>=</span> <span class=n>model</span>

    <span class=k>def</span> <span class=nf>predict</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>heartbeat</span><span class=p>:</span> <span class=n>HeartBeatCreateSchema</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
        <span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&#34;Age&#34;</span><span class=p>:</span> <span class=n>heartbeat</span><span class=o>.</span><span class=n>age</span><span class=p>,</span>
            <span class=s2>&#34;Sex&#34;</span><span class=p>:</span> <span class=n>heartbeat</span><span class=o>.</span><span class=n>sex</span><span class=p>,</span>
            <span class=s2>&#34;ChestPain&#34;</span><span class=p>:</span> <span class=n>heartbeat</span><span class=o>.</span><span class=n>chest_pain_type</span><span class=p>,</span>
            <span class=s2>&#34;FastingBS&#34;</span><span class=p>:</span> <span class=n>heartbeat</span><span class=o>.</span><span class=n>fasting_blood_sugar</span><span class=p>,</span>
            <span class=s2>&#34;MaxHR&#34;</span><span class=p>:</span> <span class=n>heartbeat</span><span class=o>.</span><span class=n>max_heart_rate</span><span class=p>,</span>
            <span class=s2>&#34;ExerciseAngina&#34;</span><span class=p>:</span> <span class=n>heartbeat</span><span class=o>.</span><span class=n>exercise_angina</span><span class=p>,</span>
            <span class=s2>&#34;Oldpeak&#34;</span><span class=p>:</span> <span class=n>heartbeat</span><span class=o>.</span><span class=n>old_peak</span><span class=p>,</span>
            <span class=s2>&#34;ST_Slope&#34;</span><span class=p>:</span> <span class=n>heartbeat</span><span class=o>.</span><span class=n>st_slope</span><span class=p>,</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>([</span><span class=n>payload</span><span class=p>]))[</span><span class=mi>0</span><span class=p>]</span>
</code></pre></div><h2 id=loading-settings-from-env>Loading settings from <code>env</code></h2><p>Below we use <a href=https://docs.pydantic.dev/latest/concepts/pydantic_settings/><code>pydantic-settings</code></a> to set up the configuration for our application. <code>pydantic-settings</code> is a powerful tool that simplifies managing and validating configuration settings with ease.</p><p>At the moment, our application might seem simple with just a path to our machine learning model checkpoint. However, as our project grows, we&rsquo;ll need to handle more complex configurations like database connection strings. In real-world applications, having a robust configuration management system is crucial for handling various settings and ensuring everything runs smoothly.</p><p>The magic happens in the <code>Settings</code> class, which is like our app’s personal assistant for configuration. It knows to read environment variables with the prefix <code>BACKEND_</code>, and ignore extra junk. As we already mentioned, we’ve only got a <code>checkpoint_path</code> that points to our model file, making sure our app knows exactly where to find it.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>Settings</span><span class=p>(</span><span class=n>BaseSettings</span><span class=p>):</span>
    <span class=n>model_config</span> <span class=o>=</span> <span class=n>SettingsConfigDict</span><span class=p>(</span>
        <span class=n>env_prefix</span><span class=o>=</span><span class=s2>&#34;BACKEND_&#34;</span><span class=p>,</span>
        <span class=n>env_file_encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span>
        <span class=n>env_nested_delimiter</span><span class=o>=</span><span class=s2>&#34;__&#34;</span><span class=p>,</span>
        <span class=n>extra</span><span class=o>=</span><span class=s2>&#34;ignore&#34;</span><span class=p>,</span>
    <span class=p>)</span>

    <span class=n>checkpoint_path</span><span class=p>:</span> <span class=n>Path</span> <span class=o>=</span> <span class=n>Path</span><span class=p>()</span><span class=o>.</span><span class=n>cwd</span><span class=p>()</span><span class=o>.</span><span class=n>parent</span> <span class=o>/</span> <span class=s2>&#34;data&#34;</span> <span class=o>/</span> <span class=s2>&#34;model.joblib&#34;</span>
</code></pre></div><h2 id=dependency-injection>Dependency Injection</h2><p>We now define a few FastAPI dependencies. Before diving deeper into the code, let&rsquo;s take a fun detour into the world of <a href=https://en.wikipedia.org/wiki/Dependency_injection><strong>Dependency Injection (DI)</strong></a>. Dependency Injection (DI) is like having a personal assistant for your code. You tell FastAPI what your functions need, and it magically delivers those needs without you lifting a finger. It’s like asking a party planner for snacks, drinks, and music—you just specify what you want, and they handle the rest.</p><blockquote><p>In FastAPI, <a href=https://fastapi.tiangolo.com/tutorial/dependencies/><code>Depends</code></a> is used to define dependencies.</p></blockquote><p>Now, let’s look at the code:</p><ul><li><code>get_settings</code>: Think of this as our settings factory, handing you a <code>Settings</code> object with all you need.</li><li><code>get_bot</code>: Here’s where FastAPI’s magic happens. It uses <code>Depends</code> to automatically provide the <code>Settings</code> needed to load our model and create a <code>Bot</code>.</li></ul><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>async</span> <span class=k>def</span> <span class=nf>get_settings</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>Settings</span><span class=p>:</span>
    <span class=k>return</span> <span class=n>Settings</span><span class=p>()</span>

<span class=n>async</span> <span class=k>def</span> <span class=nf>get_bot</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span> <span class=n>settings</span><span class=p>:</span> <span class=n>Settings</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_settings</span><span class=p>)):</span>
    <span class=n>model</span> <span class=o>=</span> <span class=n>joblib</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>settings</span><span class=o>.</span><span class=n>checkpoint_path</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>Bot</span><span class=p>(</span><span class=n>model</span><span class=p>)</span>
</code></pre></div><h2 id=defining-the-api>Defining the API</h2><p>Let&rsquo;s now set up our FastAPI app with a splash of personality:</p><ul><li><code>title="HeartBeat"</code>: The grand name of our app, ready to monitor those heartbeats!</li><li><code>description="A heart failure detection system"</code>: A quick pitch on what our app does—keeping hearts healthy.</li><li><code>version="1.0.0"</code>: Our app’s debut version—fresh and ready to go.</li><li><code>contact</code>: We’re adding a personal touch with the creator’s info, just in case anyone wants to drop a thank you note.</li><li><code>docs_url="/"</code>: The URL where our app’s documentation will live, making it super easy to check out.</li></ul><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>app</span><span class=p>:</span> <span class=n>FastAPI</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span>
    <span class=n>title</span><span class=o>=</span><span class=s2>&#34;HeartBeat&#34;</span><span class=p>,</span>
    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;A heart failure detection system&#34;</span><span class=p>,</span>
    <span class=n>version</span><span class=o>=</span><span class=s2>&#34;1.0.0&#34;</span><span class=p>,</span>
    <span class=n>contact</span><span class=o>=</span><span class=p>{</span>
        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Vassilis Sioros&#34;</span><span class=p>,</span>
        <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;billsioros97@gmail.com&#34;</span><span class=p>,</span>
    <span class=p>},</span>
    <span class=n>docs_url</span><span class=o>=</span><span class=s2>&#34;/&#34;</span><span class=p>,</span>
<span class=p>)</span>
</code></pre></div><p>We now add a new endpoint at <code>/api/v1/predict</code> where we can send heart data and get predictions in return. Here&rsquo;s the scoop:</p><ol><li>Our function takes heart data (<code>heartbeat</code>) and a <code>Bot</code> instance (automatically provided by FastAPI’s DI system).</li><li>The bot makes a prediction based on the heart data.</li><li>It creates a new <code>HeartBeatSchema</code> with a unique ID and the prediction result, ready to be sent back to the requester.</li></ol><blockquote><p>The <code>@api.post</code> decorator is a neat way to tell FastAPI, <em>&ldquo;Hey, this function should handle POST requests here!"</em> If you&rsquo;re curious about how decorators work, check out this insightful <a href=https://realpython.com/primer-on-python-decorators/><strong>RealPython article</strong></a> for a deep dive.</p></blockquote><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=nd>@app.post</span><span class=p>(</span>
    <span class=s2>&#34;/api/v1/predict&#34;</span><span class=p>,</span>
    <span class=n>response_model</span><span class=o>=</span><span class=n>HeartBeatSchema</span><span class=p>,</span>
    <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_201_CREATED</span><span class=p>,</span>
<span class=p>)</span>
<span class=n>async</span> <span class=k>def</span> <span class=nf>predict</span><span class=p>(</span>
    <span class=n>heartbeat</span><span class=p>:</span> <span class=n>HeartBeatCreateSchema</span><span class=p>,</span>
    <span class=n>bot</span><span class=p>:</span> <span class=n>Bot</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_bot</span><span class=p>),</span>
<span class=p>):</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>bot</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>heartbeat</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>HeartBeatSchema</span><span class=p>(</span>
            <span class=nb>id</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>uuid4</span><span class=p>()),</span>
            <span class=n>heart_disease</span><span class=o>=</span><span class=n>result</span><span class=p>,</span>
            <span class=o>**</span><span class=n>heartbeat</span><span class=o>.</span><span class=n>model_dump</span><span class=p>(),</span>
        <span class=p>)</span>
    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_500_INTERNAL_SERVER_ERROR</span><span class=p>,</span> <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;Unexpected error.&#34;</span><span class=p>)</span> <span class=kn>from</span> <span class=nn>e</span>
</code></pre></div><p>Alright, so here’s the deal: Running our FastAPI app in Google Colab is not as straight forward as we&rsquo;d like since Colab isn’t set up for local servers. So we use a neat trick: <a href=https://github.com/erdewit/nest_asyncio><code>nest_asyncio</code></a>.</p><blockquote><p><em>&ldquo;By design asyncio does not allow its event loop to be nested. This presents a practical problem: When in an environment where the event loop is already running it&rsquo;s impossible to run tasks and wait for the result. Trying to do so will give the error <code>RuntimeError: This event loop is already running.</code>&rdquo;</em></p><p><em>&ldquo;This module patches asyncio to allow nested use of asyncio.run and loop.run_until_complete."</em></p></blockquote><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>nest_asyncio</span>
<span class=kn>import</span> <span class=nn>uvicorn</span>

<span class=n>nest_asyncio</span><span class=o>.</span><span class=n>apply</span><span class=p>()</span>
<span class=n>uvicorn</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>app</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>8000</span><span class=p>)</span>
</code></pre></div><p>We’re up and running! For running FastAPI locally on your own machine, you just need this (<em>No Colab magic required—just simple and direct!</em>):</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>uvicorn</span>

<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
    <span class=n>uvicorn</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>app</span><span class=p>,</span> <span class=n>host</span><span class=o>=</span><span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>8000</span><span class=p>)</span>
</code></pre></div><p>We’ve dived into the exciting world of FastAPI, set up a REST API, and even integrated it with a machine learning model to build a heart failure detection system. Stay tuned for our upcoming blog posts, where we’ll explore deploying applications with Docker and Docker Compose, handling data persistence with databases, and much more 🚀 !</p></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div id=stickySideBar class=sticky-sidebar><div id=toc-wrapper><aside class=toc></aside></div><aside class=tags><ul class="tags-ul list-unstyled list-inline mb-0 text-center"><li class="list-inline-item m-1"><a href=https://billsioros.github.io/tags/python target=_blank>Python</a></li><li class="list-inline-item m-1"><a href=https://billsioros.github.io/tags/machine-learning target=_blank>Machine Learning</a></li><li class="list-inline-item m-1"><a href=https://billsioros.github.io/tags/api target=_blank>API</a></li><li class="list-inline-item m-1"><a href=https://billsioros.github.io/tags/fastapi target=_blank>FastAPI</a></li></ul></aside><aside class="social text-center"><div class="social-content mb-0"><ul class="list-inline mb-0"><li class="list-inline-item text-center"><a target=_blank href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fbillsioros.github.io%2fposts%2fheart-disease-rest-api%2f"><i class="fab fa-linkedin"></i></a></li><li class="list-inline-item text-center"><a target=_blank href="https://twitter.com/share?text=Building%20a%20REST%20API&url=https%3a%2f%2fbillsioros.github.io%2fposts%2fheart-disease-rest-api%2f"><i class="fab fa-twitter"></i></a></li><li class="list-inline-item text-center"><a target=_blank href="mailto:?subject=Building%20a%20REST%20API&body=Check%20out%20this%20site https%3a%2f%2fbillsioros.github.io%2fposts%2fheart-disease-rest-api%2f"><i class="fa fa-envelope"></i></a></li></ul></div></aside><div style=display:flex;flex-direction:row;justify-content:space-between><a href=https://billsioros.github.io/posts/heart-disease-prediction/ class="article-control previousPost"><i class="fas fa-angle-left"></i><span class="text-muted font-weight-light mx-2">Previous</span></a></div></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><div class=progress><div id=scroll-progress-bar class=progress-bar role=progressbar aria-valuenow=0 aria-valuemin=0 aria-valuemax=100></div></div><script src=/js/scrollProgressBar.js></script><script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){if(document.body.scrollTop>20||document.documentElement.scrollTop>20){topScroll.style.display="block";}else{topScroll.style.display="none";}}
function topFunction(){document.body.scrollTop=0;document.documentElement.scrollTop=0;}
let stickySideBarElem=document.getElementById("stickySideBar");let stickyNavBar=true;if(stickyNavBar){let headerElem=document.getElementById("profileHeader");let headerHeight=headerElem.offsetHeight+15;stickySideBarElem.style.top=headerHeight+"px";}else{stickySideBarElem.style.top="50px";}</script><script src=/js/readingTime.js></script><script>tocbot.init({tocSelector:'.toc',contentSelector:'.toc-content',headingSelector:'h1, h2, h3',hasInnerContainers:true,});</script></div><footer class="d-flex flex-column justify-content-end" style=flex-grow:1><div class="container py-4"><div class="row justify-content-center"><div class="col-md-4 text-center">&copy; 2024 All rights reserved</div></div></div></footer><script src=/bootstrap-5/js/bootstrap.bundle.min.js></script><script>const button_=document.getElementById("theme-toggle");if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')
button_.classList.add("light");}else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><script>const button=document.getElementById("theme-toggle");button.addEventListener("click",(event)=>{const isDark=document.body.className.includes("dark");const x=event.clientX
const y=event.clientY
const endRadius=Math.hypot(Math.max(x,innerWidth-x),Math.max(y,innerHeight-y),)
const transition=document.startViewTransition(()=>{if(isDark){document.body.classList.remove('dark');button.classList.toggle("light");localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');button.classList.toggle("light");localStorage.setItem("pref-theme",'dark');}})
transition.ready.then(()=>{const clipPath=[`circle(0px at ${x}px ${y}px)`,`circle(${endRadius}px at ${x}px ${y}px)`,]
document.documentElement.animate({clipPath:isDark?[...clipPath].reverse():clipPath,},{duration:500,easing:'ease-out',pseudoElement:isDark?'::view-transition-old(root)':'::view-transition-new(root)',},)})})
var tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList=tooltipTriggerList.map(function(tooltipTriggerEl){return new bootstrap.Tooltip(tooltipTriggerEl)})</script><script src=/js/search.js></script></body></html>